imports:
  backend: backend
  webapp: webapp
  e2e: e2e

targets:
  full_stack_run:
    dependencies: [backend::run, webapp::run]

  full_stack_docker_run:
    dependencies: [backend::docker_build, webapp::docker_build]
    service: exec docker-compose up

  e2e_docker_run:
    dependencies:
      [backend::docker_build, webapp::docker_build, e2e::docker_build]
    input:
      - paths: [docker-compose.e2e.yml, docker-compose.yml]
      - cmd_stdout: 'docker image ls todos/backend:latest --format "{{.ID}}"'
      - cmd_stdout: 'docker image ls todos/webapp:latest --format "{{.ID}}"'
      - cmd_stdout: 'docker image ls todos/e2e:latest --format "{{.ID}}"'
    output:
      - paths: [target]
    build: docker-compose -f docker-compose.yml -f docker-compose.e2e.yml up --exit-code-from todos-e2e
